<style>
    .config-group {
        background: #EEE;
        padding: 20px 15px 1px 15px;
        margin: 10px 0px;
    }

    .config-group .red-ui-typedInput-container {
        width: 100% !important;
    }

    .config-sub-group {
        margin-left: 8px;
        border-left: 5px solid #ddd;
        padding-left: 7px;
    }
</style>

<script type="text/javascript">
    function refresh() {
        RED.nodes.eachNode(function (node) {

        });
    }

    RED.sidebar.addTab({
        id: "zigbee2mqtt",
        label: "Zigbee 2 MQTT",
        name: "zigbee2mqtt",
        content: "<div class=\"nr-db-sb\">TODO: Add overview of all devices</div>",
        closeable: true,
        pinned: true,
        iconClass: "fa fa-cloud",
        disableOnEdit: true,
        onchange: function () { refresh(); }
    });

    if (RED.bavaria === undefined) {
        RED.bavaria = {
            validators: {
                range: function (min, max) {
                    return function (v) {
                        return v <= max && v >= min;
                    }
                }
            },
            ui: {
                addNumInput: function (element) {
                    $(element).typedInput({
                        type: "num",
                        types: ["num"],
                    });
                },
                addNumInputs: function (elements) {
                    elements.forEach(RED.bavaria.ui.addNumInput);
                },
                addNumRangeInput: function (element, min, max) {
                    RED.bavaria.ui.addNumInput(element);
                    var validator = RED.bavaria.validators.range(min, max);

                    $(element).change(function () {
                        var valid = validator($(this).val());
                        var targetElement = $(this).parent().find('.red-ui-typedInput-container');
                        if (!valid) {
                            targetElement.addClass('input-error');
                        } else {
                            targetElement.removeClass('input-error');
                        }
                    });
                },
                addNumRangeInputs: function (elements, min, max) {
                    elements.forEach(element => {
                        RED.bavaria.ui.addNumRangeInput(element, min, max);
                    });
                },
                addMultiInput: function (node, name) {
                    var value = node["payload" + name];
                    var type = node["type" + name];

                    var options = {
                        type: type,
                        types: ["str", "json", "num", "bool"]
                    };

                    const index = options.types.indexOf(type);

                    if (index > -1) {
                        options.types.splice(index, 1);
                        options.types.splice(0, 0, type);
                    }

                    console.log(options);
                    $("#node-input-payload" + name).typedInput(options);
                },
                saveMultiInput: function (node, name) {
                    var splits = $("#node-input-payload" + name).next().children("button").children("span").children("img").first().attr("src").split("/");
                    var type = splits[splits.length - 1].split(".")[0];

                    switch (type) {
                        case "az":
                            type = "str";
                            break;
                        case "09":
                            type = "num";
                            break;
                        case "bool":
                            type = "bool";
                            break;
                        case "json":
                            type = "json";
                            break;
                    }

                    node["customPayload" + name] = $("#node-input-payload" + name).val() !== "";
                    node["type" + name] = type;
                }
            }
        }
    }
</script>