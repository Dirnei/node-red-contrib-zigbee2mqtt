<script type="text/javascript">
    function refresh(){
        RED.nodes.eachNode(function(node) {
            
        });
    }

    RED.sidebar.addTab({
        id: "zigbee2mqtt",
        label: "Zigbee 2 MQTT",
        name: "zigbee2mqtt",
        content: "<div class=\"nr-db-sb\">TODO: Add overview of all devices</div>",
        closeable: true,
        pinned: true,
        iconClass: "fa fa-cloud",
        disableOnEdit: true,
        onchange: function() { refresh(); }
    });

    if(RED.bavaria === undefined)
    {
        RED.bavaria = {
            validators : {
                range : function(min, max) {
                    return function(v) { 
                        return v <= max && v >= min;
                    }   
                }
            },
            ui : {
                addNumInput: function(element){
                    $(element).typedInput({
                        type:"num",
                        types:["num"],
                    });
                },
                addNumInputs : function(elements){
                    elements.forEach(RED.bavaria.ui.addNumInput);
                },
                addNumRangeInput: function(element, min, max){
                    RED.bavaria.ui.addNumInput(element);
                    var validator = RED.bavaria.validators.range(min, max);
                    
                    $(element).change(function(){
                        var valid = validator($(this).val());
                        var targetElement = $(this).parent().find('.red-ui-typedInput-container');
                        if (!valid) {
                            targetElement.addClass('input-error');
                        } else {
                            targetElement.removeClass('input-error');
                        }
                    });
                },
                addNumRangeInputs : function(elements, min, max){
                    elements.forEach(element => {
                        RED.bavaria.ui.addNumRangeInput(element, min, max);
                    });
                }
            }
        }
    }
</script>

<!--- BRIDGE CONFIG NODE --->
<script type="text/javascript">
    RED.nodes.registerType('zigbee2mqtt-bridge-config',{
        category: 'config',
        defaults: {
			name:   { value: "zigbee2mqtt", required: true },
            baseTopic: { value: "zigbee2mqtt", required: true },
            broker: {value: "", required: true },
            requireLogin: {value: false},
        },
        credentials: {
            username: {type: "text"},
            password: {type: "password"},
        },
        label: function(){return this.name;},
		paletteLabel: "bridge config"
    });
</script>

<script type="text/html" data-template-name="zigbee2mqtt-bridge-config">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-config-input-name" placeholder="Name" />
    </div>	
    <div class="form-row">
        <label for="node-input-baseTopic"><i class="fa fa-tag"></i>Base MQTT Topic</label>
        <input type="text" id="node-config-input-baseTopic" placeholder="topic" />
    </div>
    <div class="form-row">
        <label for="node-input-broker"><i class="fa fa-tag"></i>Brocker</label>
        <input type="text" id="node-config-input-broker" placeholder="test.mosquitto.org" />
    </div>
    <div class="form-row">
        <label for="node-input-requireLogin"><i class="fa fa-tag"></i>Require login</label>
        <input type="checkbox" id="node-config-input-requireLogin" />
    </div>
    <div class="form-row">
        <label for="node-input-username"><i class="fa fa-tag"></i>Username</label>
        <input type="text" id="node-config-input-username" placeholder="Username" />
    </div>
    <div class="form-row">
        <label for="node-input-password"><i class="fa fa-tag"></i>Base MQTT Topic</label>
        <input type="password" id="node-config-input-password" />
    </div>
</script>  

<!--- DEVICE CONFIG NODE --->
<script type="text/javascript">
    RED.nodes.registerType('zigbee2mqtt-device-config',{
        category: 'config',
        defaults: {
			name:   { value: "", required: true },
			deviceName: { value: "", required: true },
            brightnessSupport: {value: false},
            temperatureSupport: {value: false},
            colorSupport: {value: false},
		},
        label: function(){return this.name;},
		paletteLabel: "Device config"
    });
</script>

<script type="text/html" data-template-name="zigbee2mqtt-device-config">
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-config-input-name" placeholder="Name" />
    </div>	
    <div class="form-row">
        <label for="node-config-input-deviceName"><i class="fa fa-tag"></i> Device name</label>
        <input type="text" id="node-config-input-deviceName" placeholder="Device name" />
    </div>
    <div class="form-row">
        <label for="node-config-input-brightnessSupport"><i class="fa fa-tag"></i> Dimmable</label>
        <input type="checkbox" id="node-config-input-brightnessSupport" />
    </div>
    <div class="form-row">
        <label for="node-config-input-temperatureSupport"><i class="fa fa-tag"></i> Temperature Support</label>
        <input type="checkbox" id="node-config-input-temperatureSupport" />
    </div>
    <div class="form-row">
        <label for="node-config-input-colorSupport"><i class="fa fa-tag"></i> Color Support</label>
        <input type="checkbox" id="node-config-input-colorSupport" />
    </div>
</script>

<!--- GENERIC LAMP NODE --->
<script type="text/javascript">
    function showInput(name)
    {
        $("#node-input-" + name).parent().show();
    }

    function hideInput(name)
    {
        $("#node-input-" + name).parent().hide();
    }

    function prepareView()
    {
        var config = RED.nodes.node($("#node-input-device").val());

        if(config === undefined || config === null)
        {
            return;
        }

        if (config.brightnessSupport)
        {
            showInput("transition");
            showInput("brightness");
        }
        else
        {
            hideInput("brightness");
            hideInput("transition");
        }

        if (config.temperatureSupport)
        {
            showInput("temperature");
        }
        else
        {
            hideInput("temperature");
        }

        if (config.colorSupport)
        {
            showInput("red");
            showInput("green");
            showInput("blue");
        }
        else
        {
            hideInput("red");
            hideInput("green");
            hideInput("blue");
        }

        return true;
    }

    RED.nodes.registerType('generic-lamp',{
        category: 'zigbee2mqtt',
        color: '#bada66',
        defaults: {
            device: {
                value: "", 
                type: "zigbee2mqtt-device-config", 
                validate: function(value){
                    prepareView();
                    return true;
                }
            },

            name: {value: ""},
            state: {value:"ON" },

            brightness: {value:0, validate: RED.bavaria.validators.range(0, 255) },

            temperature: {value:50, validate: RED.bavaria.validators.range(0, 500) },

            red: {value:0, validate: RED.bavaria.validators.range(0, 255) },
            green: {value:0, validate: RED.bavaria.validators.range(0, 255) },
            blue: {value:0, validate: RED.bavaria.validators.range(0, 255) },

            transition: {value:2},
            delay: {value:0},
        },
        inputs:1,
        outputs:1,
        icon: "light.png",
        label: function() {
            return this.name||"generic device";
        },
        oneditprepare: function(){           
            var numInputs = [
                "#node-input-brightness",
                "#node-input-red",
                "#node-input-green",
                "#node-input-blue",
            ]

            RED.bavaria.ui.addNumRangeInput("#node-input-temperature", 0, 500);  
            
            RED.bavaria.ui.addNumRangeInputs(numInputs, 0, 255);   
 
            RED.bavaria.ui.addNumInput("#node-input-delay");  
            RED.bavaria.ui.addNumInput("#node-input-transition");  
            
            prepareView();
        },
        oneditsave: function(){
            var config = RED.nodes.node($("#node-input-device").val());
            $("#node-input-name").val(config.name);
        },
    });
</script>

<script type="text/html" data-template-name="generic-lamp">
    
    <div class="form-row">
        <label for="node-input-device"><i class="fa fa-tag"></i> Device</label>
        <input type="text" id="node-input-device" placeholder="device" />
    </div>
    <div class="form-row" style="display:none">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="hidden" id="node-input-name">
    </div>

    <div class="form-row">
        <label for="node-input-state"><i class="fa fa-power-off"></i> State</label>
        <select id="node-input-state">
            <option value="ON">On</option>
            <option value="OFF">Off</option>
            <option value="TOGGLE">Toggle</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-brightness"><i class="fa fa-sun-o"></i> Brightness</label>
        <input type="text" id="node-input-brightness">
    </div>
    <div class="form-row">
        <label for="node-input-temperature"><i class="fa fa-thermometer-full"></i> Temperature</label>
        <input type="text" id="node-input-temperature">
    </div>
    <div class="form-row">
        <label for="node-input-red"><i class="fa fa-paint-brush"></i> Red</label>
        <input type="text" id="node-input-red">
    </div>
    <div class="form-row">
        <label for="node-input-green"><i class="fa fa-paint-brush"></i> Green</label>
        <input type="text" id="node-input-green">
    </div>
    <div class="form-row">
        <label for="node-input-blue"><i class="fa fa-paint-brush"></i> Blue</label>
        <input type="text" id="node-input-blue">
    </div>
    <div class="form-row">
        <label for="node-input-transition"><i class="fa fa-clock-o"></i> Transition</label>
        <input type="text" id="node-input-transition">
    </div>
    <div class="form-row">
        <label for="node-input-delay"><i class="fa fa-clock-o"></i> Delay</label>
        <input type="text" id="node-input-delay" >
    </div>
</script>

<script type="text/html" data-help-name="generic-lamp">
    <p>Node for generic lamp devices</p>
</script>

<!--- IKEA DIMMER NODE --->
<script type="text/javascript">

    RED.nodes.registerType('ikea-dimmer',{
        category: 'zigbee2mqtt-ikea',
        color: '#fd0',
        defaults: {
            name: { value: "" },
            bridge: {value: "", type: "zigbee2mqtt-bridge-config"},
            deviceName: {value: "", required: true},
        },
        inputs:0,
        outputs:5,
        icon: "inject.png",
        label: function() {
            return this.name || "Ikea Dimmer";
        },
        outputLabels: ["on","off","dimm up","dimm down","dimm stop"],
    });

</script>

<script type="text/html" data-template-name="ikea-dimmer">
    
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-bridge"><i class="fa fa-tag"></i> Bridge</label>
        <input type="text" id="node-input-bridge" placeholder="bridge" />
    </div>
    <div class="form-row">
        <label for="node-input-deviceName"><i class="fa fa-tag"></i> Devicename</label>
        <input type="text" id="node-input-deviceName">
    </div>

</script>

<script type="text/html" data-help-name="ikea-dimmer">
    <p>Node for Ikea dimmer input device</p>
</script>

<!--- IKEA REMOTE NODE --->
<script type="text/javascript">

    RED.nodes.registerType('ikea-remote',{
        category: 'zigbee2mqtt-ikea',
        color: '#fd0',
        defaults: {
            name: { value: "" },
            bridge: {value: "", type: "zigbee2mqtt-bridge-config"},
            deviceName: {value: "", required: true},
        },
        inputs:0,
        outputs:5,
        icon: "inject.png",
        label: function() {
            return this.name || "Ikea Remote";
        },
        outputLabels: ["toggle","up","down","left","right"],
    });

</script>

<script type="text/html" data-template-name="ikea-remote">
    
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-bridge"><i class="fa fa-tag"></i> Bridge</label>
        <input type="text" id="node-input-bridge" placeholder="bridge" />
    </div>
    <div class="form-row">
        <label for="node-input-deviceName"><i class="fa fa-tag"></i> Devicename</label>
        <input type="text" id="node-input-deviceName">
    </div>

</script>

<script type="text/html" data-help-name="ikea-remote">
    <p>Node for Ikea remote input device</p>
</script>

<!--- SCENIC FOH SWITCH NODE --->
<script type="text/javascript">

    RED.nodes.registerType('scenic-foh-switch',{
        category: 'zigbee2mqtt-scenic-foh',
        color: '#f5f5f5',
        defaults: {
            name: { value: "" },
            bridge: {value: "", type: "zigbee2mqtt-bridge-config"},
            deviceName: {value: "", required: true},
        },
        inputs:0,
        outputs:6,
        icon: "inject.png",
        label: function() {
            return this.name || "Scenic FoH Switch";
        },
        outputLabels: ["A0","A1","B0","B1","UP","DOWN",],
    });

</script>

<script type="text/html" data-template-name="scenic-foh-switch">
    
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-bridge"><i class="fa fa-tag"></i> Bridge</label>
        <input type="text" id="node-input-bridge" placeholder="bridge" />
    </div>
    <div class="form-row">
        <label for="node-input-deviceName"><i class="fa fa-tag"></i> Devicename</label>
        <input type="text" id="node-input-deviceName">
    </div>

</script>

<script type="text/html" data-help-name="scenic-foh-switch">
    <p>Node for Scenic Friend of Hue Smartswitch input device</p>
</script>

<!--- CONTACT SENSOR NODE --->
<script type="text/javascript">

    RED.nodes.registerType('contact-sensor',{
        category: 'zigbee2mqtt-sensor',
        color: '#fcba03',
        defaults: {
            name: { value: "" },
            bridge: {value: "", type: "zigbee2mqtt-bridge-config"},
            deviceName: {value: "", required: true},
        },
        inputs:0,
        outputs:2,
        icon: "feed.png",
        label: function() {
            return this.name || "Contact sensor";
        },
        outputLabels: ["closed","open"],
    });

</script>

<script type="text/html" data-template-name="contact-sensor">
    
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-bridge"><i class="fa fa-tag"></i> Bridge</label>
        <input type="text" id="node-input-bridge" placeholder="bridge" />
    </div>
    <div class="form-row">
        <label for="node-input-deviceName"><i class="fa fa-tag"></i> Devicename</label>
        <input type="text" id="node-input-deviceName">
    </div>

</script>

<script type="text/html" data-help-name="contact-sensor">
    <p>Node for contact sensor input device</p>
</script>

<!--- OCCUPANCY SENSOR NODE --->
<script type="text/javascript">

    RED.nodes.registerType('occupancy-sensor',{
        category: 'zigbee2mqtt-sensor',
        color: '#fcba03',
        defaults: {
            name: { value: "" },
            bridge: {value: "", type: "zigbee2mqtt-bridge-config"},
            deviceName: {value: "", required: true},
        },
        inputs:0,
        outputs:2,
        icon: "feed.png",
        label: function() {
            return this.name || "Occupancy sensor";
        },
        outputLabels: ["occupied","no motion"],
    });

</script>

<script type="text/html" data-template-name="occupancy-sensor">
    
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-bridge"><i class="fa fa-tag"></i> Bridge</label>
        <input type="text" id="node-input-bridge" placeholder="bridge" />
    </div>
    <div class="form-row">
        <label for="node-input-deviceName"><i class="fa fa-tag"></i> Devicename</label>
        <input type="text" id="node-input-deviceName">
    </div>

</script>

<script type="text/html" data-help-name="occupancy-sensor">
    <p>Node for occupancy sensor input device</p>
</script>

<!--- BUTTON SWITCH NODE --->
<script type="text/javascript">

    RED.nodes.registerType('button-switch',{
        category: 'zigbee2mqtt-utils',
        color: '#97f798',
        defaults: {
            name: { value: "" },
        },
        inputs:1,
        outputs:3,
        icon: "function.png",
        label: function() {
            return this.name || "button-switch";
        },
        outputLabels: ["pressed","hold","released","double"],
        oneditprepare: function(){
            RED.bavaria.ui.addNumRangeInput("#node-input-brightness", 0, 255);   
        },
    });
</script>

<script type="text/html" data-template-name="button-switch">
    
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>

</script>

<script type="text/html" data-help-name="button-switch">
    <p>Node to switch button press types</p>
</script>

<!--- PREPARE MESSAGES NODE --->
<script type="text/javascript">

    RED.nodes.registerType('send-messages',{
        category: 'zigbee2mqtt',
        color: '#bada66',
        defaults: {
            name: { value: "" },
            bridge: {value: "", type: "zigbee2mqtt-bridge-config"},
        },
        inputs:1,
        outputs:0,
        icon: "bridge.svg",
        label: function() {
            return this.name || "send messages";
        },
    });
</script>

<script type="text/html" data-template-name="send-messages">
    
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-bridge"><i class="fa fa-tag"></i> Bridge</label>
        <input type="text" id="node-input-bridge" placeholder="bridge" />
    </div>

</script>

<script type="text/html" data-help-name="send-messages">
    <p>Node to send messages to devices</p>
</script>

<!--- OVERRIDE BRIGHTNESS NODE --->
<script type="text/javascript">

    RED.nodes.registerType('override-brightness',{
        category: 'zigbee2mqtt',
        color: '#bada66',
        defaults: {
            name: { value: "" },
            brightness: { value: 255, validate: RED.bavaria.validators.range(0, 255) },
        },
        inputs:1,
        outputs:1,
        icon: "template.png",
        label: function() {
            return this.name || "override-brightness";
        },
        oneditprepare: function(){
            RED.bavaria.ui.addNumRangeInput("#node-input-brightness", 0, 255);   
        },
    });
</script>

<script type="text/html" data-template-name="override-brightness">
    
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>

    <div class="form-row">
        <label for="node-input-brightness"><i class="fa fa-sun-o"></i> Brightness</label>
        <input type="text" id="node-input-brightness">
    </div>

</script>

<script type="text/html" data-help-name="override-brightness">
    <p>Node to override brightness</p>
</script>

<!--- OVERRIDE TEMPERATURE NODE --->
<script type="text/javascript">

    RED.nodes.registerType('override-temperature',{
        category: 'zigbee2mqtt',
        color: '#bada66',
        defaults: {
            name: { value: "" },
            temperature: { value: 255, validate: RED.bavaria.validators.range(0, 500) },
        },
        inputs:1,
        outputs:1,
        icon: "template.png",
        label: function() {
            return this.name || "override-temperature";
        },
        oneditprepare: function(){   
            RED.bavaria.ui.addNumRangeInput("#node-input-temperature", 0, 500);         
        },
    });
</script>

<script type="text/html" data-template-name="override-temperature">
    
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>

    <div class="form-row">
        <label for="node-input-temperature"><i class="fa fa-thermometer-full"></i> Temperature</label>
        <input type="text" id="node-input-temperature">
    </div>

</script>

<script type="text/html" data-help-name="override-temperature">
    <p>Node to overrite color temperature</p>
</script>

<!--- OVERRIDE COLOR NODE --->
<script type="text/javascript">

    RED.nodes.registerType('override-color',{
        category: 'zigbee2mqtt',
        color: '#bada66',
        defaults: {
            name: { value: "" },
            red: { value: 255, validate: RED.bavaria.validators.range(0,255) },
            green: { value: 255, validate: RED.bavaria.validators.range(0,255) },
            blue: { value: 255, validate: RED.bavaria.validators.range(0,255) },
        },
        inputs:1,
        outputs:1,
        icon: "template.png",
        label: function() {
            return this.name || "override-color";
        },
        oneditprepare: function(){   
            var numInputs = ["#node-input-red", "#node-input-green", "#node-input-blue"];
            RED.bavaria.ui.addNumRangeInputs(numInputs, 0, 255);
        },
    });
</script>

<script type="text/html" data-template-name="override-color">
    
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>

    <div class="form-row">
        <label for="node-input-temperature"><i class="fa fa-paint-brush"></i> Red</label>
        <input type="text" id="node-input-red">
    </div>

    <div class="form-row">
        <label for="node-input-temperature"><i class="fa fa-paint-brush"></i> Green</label>
        <input type="text" id="node-input-green">
    </div>

    <div class="form-row">
        <label for="node-input-temperature"><i class="fa fa-paint-brush"></i> Blue</label>
        <input type="text" id="node-input-blue">
    </div>

</script>

<script type="text/html" data-help-name="override-temperature">
    <p>Node to override color</p>
</script>