<script type="text/javascript">
    function refresh() {
        RED.nodes.eachNode(function (node) {

        });
    }

    RED.sidebar.addTab({
        id: "zigbee2mqtt",
        label: "Zigbee 2 MQTT",
        name: "zigbee2mqtt",
        content: "<div class=\"nr-db-sb\">TODO: Add overview of all devices</div>",
        closeable: true,
        pinned: true,
        iconClass: "fa fa-cloud",
        disableOnEdit: true,
        onchange: function () { refresh(); }
    });

    if (RED.bavaria === undefined) {
        RED.bavaria = {
            validators: {
                range: function (min, max) {
                    return function (v) {
                        return v <= max && v >= min;
                    }
                }
            },
            ui: {
                addNumInput: function (element) {
                    $(element).typedInput({
                        type: "num",
                        types: ["num"],
                    });
                },
                addNumInputs: function (elements) {
                    elements.forEach(RED.bavaria.ui.addNumInput);
                },
                addNumRangeInput: function (element, min, max) {
                    RED.bavaria.ui.addNumInput(element);
                    var validator = RED.bavaria.validators.range(min, max);

                    $(element).change(function () {
                        var valid = validator($(this).val());
                        var targetElement = $(this).parent().find('.red-ui-typedInput-container');
                        if (!valid) {
                            targetElement.addClass('input-error');
                        } else {
                            targetElement.removeClass('input-error');
                        }
                    });
                },
                addNumRangeInputs: function (elements, min, max) {
                    elements.forEach(element => {
                        RED.bavaria.ui.addNumRangeInput(element, min, max);
                    });
                }
            }
        }
    }
</script>

<!--- BRIDGE CONFIG NODE --->
<script type="text/javascript">
    RED.nodes.registerType('zigbee2mqtt-bridge-config', {
        category: 'config',
        defaults: {
            name: { value: "zigbee2mqtt", required: true },
            baseTopic: { value: "zigbee2mqtt", required: true },
            broker: { value: "mqtt://localhost", required: true },
            requireLogin: { value: false },
        },
        credentials: {
            username: { type: "text" },
            password: { type: "password" },
        },
        label: function () { return this.name; },
        paletteLabel: "bridge config"
    });
</script>

<script type="text/html" data-template-name="zigbee2mqtt-bridge-config">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-config-input-name" placeholder="Name" />
    </div>	
    <div class="form-row">
        <label for="node-input-baseTopic"><i class="fa fa-tag"></i> Base MQTT Topic</label>
        <input type="text" id="node-config-input-baseTopic" placeholder="topic" />
    </div>
    <div class="form-row">
        <label for="node-input-broker"><i class="fa fa-tag"></i> Broker</label>
        <input type="text" id="node-config-input-broker" placeholder="test.mosquitto.org" />
    </div>
    <div class="form-row">
        <label for="node-input-requireLogin"><i class="fa fa-tag"></i> Require login</label>
        <input type="checkbox" id="node-config-input-requireLogin" />
    </div>
    <div class="form-row">
        <label for="node-input-username"><i class="fa fa-tag"></i> Username</label>
        <input type="text" id="node-config-input-username" placeholder="Username" />
    </div>
    <div class="form-row">
        <label for="node-input-password"><i class="fa fa-tag"></i> Password</label>
        <input type="password" id="node-config-input-password" />
    </div>
</script>

<script type="text/html" data-help-name="zigbee2mqtt-bridge-config">
    <p>
        Configure your connection to your MQTT Broker and zigbee2mqtt. This is needed in order to get or send messages via MQTT to zigbee2mqtt
    </p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt class="required">Base MQTT Topic <span class="property-type">string</span></dt>
        <dd>The base topic which is configured in the configuration.yml in zigbee2mqtt. Usually: <code>zigbee2mqtt</code></dd>
        <dt class="required">Broker <span class="property-type">string</span></dt>
        <dd>Connects to the broker specified by the given URL. The URL can be on the following protocols: 'mqtt', 'mqtts', 'tcp', 'tls', 'ws', 'wss'.
            Example: <code>mqtt://localhost</code>
        </dd>
        <dt class="optional">Require login <span class="property-type">bool</span></dt>
        <dd>Check if your MQTT broker needs a login in order to connect. If checked the username and password below are required</dd>
        <dt class="optional">Username <span class="property-type">string</span></dt>
        <dd>The username to connect to your MQTT broker</dd>
        <dt class="optional">Password <span class="property-type">string</span></dt>
        <dd>The password to connect to your MQTT broker</dd>
    </dl>
</script>

<!--- DEVICE CONFIG NODE --->
<script type="text/javascript">
    RED.nodes.registerType('zigbee2mqtt-device-config', {
        category: 'config',
        defaults: {
            name: { value: "", required: true },
            bridge: { value: "", type: "zigbee2mqtt-bridge-config" },
            deviceName: { value: "", required: true },
            brightnessSupport: { value: false },
            temperatureSupport: { value: false },
            colorSupport: { value: false },
            genericMqttDevice: { value: false },
            statusTopic: { value: "" },
            commandTopic: { value: "" },
            refreshTopic: { value: "" },
        },
        label: function () { return this.name; },
        paletteLabel: "Device config",
        oneditprepare: function () {
            var node = this;
            var deviceName = node.deviceName;

            if (node.genericMqttDevice === true) {
                $("#fullMqttTopic").show()
            } else {
                $("#fullMqttTopic").hide()
            }

            $("#node-config-input-genericMqttDevice").change(function () {
                if (this.checked) {
                    $("#fullMqttTopic").show()
                    node.deviceName = "---";
                } else {
                    $("#fullMqttTopic").hide()
                    node.deviceName = "";
                }
            })

            $("#node-config-input-bridge").change(function () {
                var bridgeId = $("#node-config-input-bridge").val().replace(".", "_");
                $.getJSON('/z2m/devices/' + bridgeId + '/router/all/all', function (data) {
                    $("#node-config-input-deviceName").empty();
                    data.devices.forEach(e => {
                        $("#node-config-input-deviceName").append("<option>" + e.friendly_name + "</option>");
                    });

                    $("#node-config-input-deviceName").val(deviceName);
                });
            });
        }
    });
</script>

<script type="text/html" data-template-name="zigbee2mqtt-device-config">
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-config-input-name" placeholder="Name" />
    </div>	
    <div class="form-row">
        <label for="node-config-input-bridge"><i class="fa fa-tag"></i> Bridge</label>
        <input type="text" id="node-config-input-bridge"  />
    </div>
    <div class="form-row">
        <label for="node-config-input-deviceName"><i class="fa fa-tag"></i> Device</label>
        <select id="node-config-input-deviceName"></select>
    </div>
    <div class="form-row">
        <label for="node-config-input-brightnessSupport"><i class="fa fa-tag"></i> Dimmable</label>
        <input type="checkbox" id="node-config-input-brightnessSupport" />
    </div>
    <div class="form-row">
        <label for="node-config-input-temperatureSupport"><i class="fa fa-tag"></i> Temperature Support</label>
        <input type="checkbox" id="node-config-input-temperatureSupport" />
    </div>
    <div class="form-row">
        <label for="node-config-input-colorSupport"><i class="fa fa-tag"></i> Color Support</label>
        <input type="checkbox" id="node-config-input-colorSupport" />
    </div>
    <div class="form-row">
        <h3>Non zigbee2mqtt device support (experimental)</h3>
        <label for="node-config-input-genericMqttDevice"><i class="fa fa-tag"></i> Is generic mqtt device</label>
        <input type="checkbox" id="node-config-input-genericMqttDevice" />
    </div>

    <div id="fullMqttTopic">
        <div class="form-row">
            <label for="node-config-input-fullMqttTopic"><i class="fa fa-tag"></i> Status Topic</label>
            <input type="text" id="node-config-input-statusTopic" />
        </div>
        <div class="form-row">
            <label for="node-config-input-fullMqttTopic"><i class="fa fa-tag"></i> Command Topic</label>
            <input type="text" id="node-config-input-commandTopic" />
        </div>
        <div class="form-row">
            <label for="node-config-input-fullMqttTopic"><i class="fa fa-tag"></i> Refresh Topic</label>
            <input type="text" id="node-config-input-refreshTopic" />
        </div>
    </div>
</script>

<!--- GENERIC LAMP NODE --->
<script type="text/javascript">
    function showInput(name) {
        $("#node-input-" + name).parent().show();
    }

    function hideInput(name) {
        $("#node-input-" + name).parent().hide();
    }

    function prepareView() {
        var config = RED.nodes.node($("#node-input-device").val());

        if (config === undefined || config === null) {
            return;
        }

        if (config.brightnessSupport) {
            showInput("transition");
            showInput("brightness");
        }
        else {
            hideInput("brightness");
            hideInput("transition");
        }

        if (config.temperatureSupport) {
            showInput("temperature");
        }
        else {
            hideInput("temperature");
        }

        if (config.colorSupport) {
            showInput("red");
            showInput("green");
            showInput("blue");
        }
        else {
            hideInput("red");
            hideInput("green");
            hideInput("blue");
        }

        return true;
    }

    RED.nodes.registerType('generic-lamp', {
        category: 'zigbee2mqtt',
        color: '#bada66',
        defaults: {
            device: {
                value: "",
                type: "zigbee2mqtt-device-config",
                validate: function (value) {
                    prepareView();
                    return true;
                }
            },

            bridge: { value: "", type: "zigbee2mqtt-bridge-config" },

            name: { value: "" },
            state: { value: "ON" },

            brightness: { value: 0, validate: RED.bavaria.validators.range(0, 255) },

            temperature: { value: 50, validate: RED.bavaria.validators.range(0, 500000) },

            red: { value: 0, validate: RED.bavaria.validators.range(0, 255) },
            green: { value: 0, validate: RED.bavaria.validators.range(0, 255) },
            blue: { value: 0, validate: RED.bavaria.validators.range(0, 255) },

            transition: { value: 2 },
            delay: { value: 0 },
        },
        inputs: 1,
        outputs: 1,
        icon: "light.png",
        label: function () {
            return this.name || "generic device";
        },
        oneditprepare: function () {
            var numInputs = [
                "#node-input-brightness",
                "#node-input-red",
                "#node-input-green",
                "#node-input-blue",
            ]

            RED.bavaria.ui.addNumRangeInput("#node-input-temperature", 0, 500000);

            RED.bavaria.ui.addNumRangeInputs(numInputs, 0, 255);

            RED.bavaria.ui.addNumInput("#node-input-delay");
            RED.bavaria.ui.addNumInput("#node-input-transition");

            prepareView();
        },
        oneditsave: function () {
            var config = RED.nodes.node($("#node-input-device").val());
            $("#node-input-name").val(config.name);
        },
    });
</script>

<script type="text/html" data-template-name="generic-lamp">

    <div class="form-row">
        <label for="node-input-device"><i class="fa fa-tag"></i> Device</label>
        <input type="text" id="node-input-device" />
    </div>
    <div class="form-row">
        <label for="node-input-bridge"><i class="fa fa-tag"></i> Bridge</label>
        <input type="text" id="node-input-bridge"  />
    </div>
    <div class="form-row" style="display:none">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="hidden" id="node-input-name">
    </div>

    <div class="form-row">
        <label for="node-input-state"><i class="fa fa-power-off"></i> State</label>
        <select id="node-input-state">
            <option value="ON">On</option>
            <option value="OFF">Off</option>
            <option value="TOGGLE">Toggle</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-brightness"><i class="fa fa-sun-o"></i> Brightness</label>
        <input type="text" id="node-input-brightness">
    </div>
    <div class="form-row">
        <label for="node-input-temperature"><i class="fa fa-thermometer-full"></i> Temperature</label>
        <input type="text" id="node-input-temperature">
    </div>
    <div class="form-row">
        <label for="node-input-red"><i class="fa fa-paint-brush"></i> Red</label>
        <input type="text" id="node-input-red">
    </div>
    <div class="form-row">
        <label for="node-input-green"><i class="fa fa-paint-brush"></i> Green</label>
        <input type="text" id="node-input-green">
    </div>
    <div class="form-row">
        <label for="node-input-blue"><i class="fa fa-paint-brush"></i> Blue</label>
        <input type="text" id="node-input-blue">
    </div>
    <div class="form-row">
        <label for="node-input-transition"><i class="fa fa-clock-o"></i> Transition</label>
        <input type="text" id="node-input-transition">
    </div>
    <div class="form-row">
        <label for="node-input-delay"><i class="fa fa-clock-o"></i> Delay</label>
        <input type="text" id="node-input-delay" >
    </div>
</script>

<script type="text/html" data-help-name="generic-lamp">
    <p>Node for generic lamp devices</p>
</script>

<!--- SONOFF BUTTON NODE --->
<script type="text/javascript">

    RED.nodes.registerType('sonoff-button', {
        category: 'zigbee2mqtt_sonoff',
        color: '#fd0',
        defaults: {
            name: { value: "" },
            bridge: { value: "", type: "zigbee2mqtt-bridge-config" },
            deviceName: { value: "", required: true },
        },
        inputs: 0,
        outputs: 1,
        icon: "inject.png",
        label: function () {
            return this.name || "Sonoff Button";
        },
        oneditprepare: function () {
            var node = this;
            var deviceName = node.deviceName;

            $("#node-input-bridge").change(function () {
                var bridgeId = $("#node-input-bridge").val().replace(".", "_");
                $.getJSON('/z2m/devices/' + bridgeId + '/endDevice/sonoff/SNZB-01', function (data) {
                    $("#node-input-deviceName").empty();
                    data.devices.forEach(e => {
                        $("#node-input-deviceName").append("<option>" + e.friendly_name + "</option>");
                    });

                    $("#node-input-deviceName").val(deviceName);
                });
            });
        }
    });

</script>

<script type="text/html" data-template-name="sonoff-button">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-bridge"><i class="fa fa-tag"></i> Bridge</label>
        <input type="text" id="node-input-bridge" placeholder="bridge" />
    </div>
    <div class="form-row">
        <label for="node-input-deviceName"><i class="fa fa-tag"></i> Device</label>
        <select id="node-input-deviceName"></select>
    </div>

</script>

<script type="text/html" data-help-name="sonoff-button">
    <p>Sends a new message when a sonoff touch button is pressed.</p>
    <p>It is only compatible with SONOFF touch button (Model: SNZB-01)</p>
    <h3>Output</h3>
    <dl class="message-properties">
        <dt> button_name <span class="property-type"> string </span> </dt>
        <dd> The name of the button that was pressed </dd>
        <dt> button_type  <span class="property-type"> string </span> </dt>
        <dd>
            The type in wich way the button was pressed. Following types are available:
            <ul>
                <li><code>pressed</code> - single press</li>
                <li><code>released</code> - hold for a few seconds</li>
                <li><code>double</code> - double press</li>
            </ul>
        </dd>
    </dl>
</script>

<!--- IKEA DIMMER NODE --->
<script type="text/javascript">

    RED.nodes.registerType('ikea-dimmer', {
        category: 'zigbee2mqtt_ikea',
        color: '#fd0',
        defaults: {
            name: { value: "" },
            bridge: { value: "", type: "zigbee2mqtt-bridge-config" },
            deviceName: { value: "", required: true },
        },
        inputs: 0,
        outputs: 5,
        icon: "inject.png",
        label: function () {
            return this.name || "Ikea Dimmer";
        },
        outputLabels: ["on", "off", "dimm up", "dimm down", "dimm stop"],
        oneditprepare: function () {
            var node = this;
            var deviceName = node.deviceName;

            $("#node-input-bridge").change(function () {
                var bridgeId = $("#node-input-bridge").val().replace(".", "_");
                $.getJSON('/z2m/devices/' + bridgeId + '/endDevice/IKEA/E1743', function (data) {
                    $("#node-input-deviceName").empty();
                    data.devices.forEach(e => {
                        $("#node-input-deviceName").append("<option>" + e.friendly_name + "</option>");
                    });

                    $("#node-input-deviceName").val(deviceName);
                });
            });
        }
    });

</script>

<script type="text/html" data-template-name="ikea-dimmer">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-bridge"><i class="fa fa-tag"></i> Bridge</label>
        <input type="text" id="node-input-bridge" placeholder="bridge" />
    </div>
    <div class="form-row">
        <label for="node-input-deviceName"><i class="fa fa-tag"></i> Device</label>
        <select id="node-input-deviceName"></select>
    </div>

</script>

<script type="text/html" data-help-name="ikea-dimmer">
    <p>Sends a new message when a Ikea remote button is pressed.</p>
    <p>It is only compatible with Ikea remotes (Model: E1743)</p>
    <h3>Output</h3>
    <dl class="message-properties">
        <dt> button_name <span class="property-type"> string </span> </dt>
        <dd> The name of the button that was pressed </dd>
        <dt> button_type  <span class="property-type"> string </span> </dt>
        <dd>
            The type in wich way the button was pressed. Following types are available:
            <ul>
                <li><code>pressed</code> - single press</li>
                <li><code>hold</code> - when a button is hold down for a bit</li>
                <li><code>released</code> - when a hold down button was being released</li>
            </ul>
        </dd>
    </dl>
</script>

<!--- IKEA REMOTE NODE --->
<script type="text/javascript">

    RED.nodes.registerType('ikea-remote', {
        category: 'zigbee2mqtt_ikea',
        color: '#fd0',
        defaults: {
            name: { value: "" },
            bridge: { value: "", type: "zigbee2mqtt-bridge-config" },
            deviceName: { value: "", required: true },
        },
        inputs: 0,
        outputs: 5,
        icon: "inject.png",
        label: function () {
            return this.name || "Ikea Remote";
        },
        outputLabels: ["toggle", "up", "down", "left", "right"],
        oneditprepare: function () {
            var node = this;
            var deviceName = node.deviceName;

            $("#node-input-bridge").change(function () {
                var bridgeId = $("#node-input-bridge").val().replace(".", "_");
                $.getJSON('/z2m/devices/' + bridgeId + '/endDevice/IKEA/E1524%2FE1810', function (data) {
                    $("#node-input-deviceName").empty();
                    data.devices.forEach(e => {
                        $("#node-input-deviceName").append("<option>" + e.friendly_name + "</option>");
                    });

                    $("#node-input-deviceName").val(deviceName);
                });
            });
        }
    });

</script>

<script type="text/html" data-template-name="ikea-remote">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-bridge"><i class="fa fa-tag"></i> Bridge</label>
        <input type="text" id="node-input-bridge" placeholder="bridge" />
    </div>
    <div class="form-row">
        <label for="node-input-deviceName"><i class="fa fa-tag"></i> Device</label>
        <select id="node-input-deviceName"></select>
    </div>

</script>

<script type="text/html" data-help-name="ikea-remote">
    <p>Sends a new message when a Ikea remote button is pressed.</p>
    <p>It is only compatible with Ikea remotes (Model: E1524/E1810)</p>
    <h3>Output</h3>
    <dl class="message-properties">
        <dt> button_name <span class="property-type"> string </span> </dt>
        <dd> The name of the button that was pressed </dd>
        <dt> button_type  <span class="property-type"> string </span> </dt>
        <dd>
            The type in wich way the button was pressed. Following types are available:
            <ul>
                <li><code>pressed</code> - single press</li>
                <li><code>hold</code> - when a button is hold down for a bit</li>
                <li><code>released</code> - when a hold down button was being released</li>
            </ul>
        </dd>
    </dl>
</script>

<!--- SCENIC FOH SWITCH NODE --->
<script type="text/javascript">

    RED.nodes.registerType('scenic-foh-switch', {
        category: 'zigbee2mqtt_scenic',
        color: '#f5f5f5',
        defaults: {
            name: { value: "" },
            bridge: { value: "", type: "zigbee2mqtt-bridge-config" },
            deviceName: { value: "", required: true },
        },
        inputs: 0,
        outputs: 6,
        icon: "inject.png",
        label: function () {
            return this.name || "Scenic FoH Switch";
        },
        outputLabels: ["A0", "A1", "B0", "B1", "UP", "DOWN",],
        oneditprepare: function () {
            var node = this;
            var deviceName = node.deviceName;

            $("#node-input-bridge").change(function () {
                var bridgeId = $("#node-input-bridge").val().replace(".", "_");
                $.getJSON('/z2m/devices/' + bridgeId + '/endDevice/GreenPower/GreenPower_On_Off_Switch', function (data) {
                    $("#node-input-deviceName").empty();
                    data.devices.forEach(e => {
                        $("#node-input-deviceName").append("<option>" + e.friendly_name + "</option>");
                    });

                    $("#node-input-deviceName").val(deviceName);
                });
            });
        }
    });

</script>

<script type="text/html" data-template-name="scenic-foh-switch">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-bridge"><i class="fa fa-tag"></i> Bridge</label>
        <input type="text" id="node-input-bridge" placeholder="bridge" />
    </div>
    <div class="form-row">
        <label for="node-input-deviceName"><i class="fa fa-tag"></i> Device</label>
        <select id="node-input-deviceName"></select>
    </div>

</script>

<script type="text/html" data-help-name="scenic-foh-switch">
    <p>Sends a new message when a Scenic Friends of Hue button is pressed.</p>
    <p>It is only compatible with Scenic Friends of Hue smart switch (Model: GreenPower_On_Off_Switch)</p>
    <h3>Output</h3>
    <dl class="message-properties">
        <dt> button_name <span class="property-type"> string </span> </dt>
        <dd> The name of the button that was pressed </dd>
        <dt> button_type  <span class="property-type"> string </span> </dt>
        <dd>
            The type in wich way the button was pressed. Following types are available:
            <ul>
                <li><code>pressed</code> - single press</li>
                <li><code>released</code> - hold for a few seconds</li>
            </ul>
        </dd>
    </dl>
</script>

<!--- CONTACT SENSOR NODE --->
<script type="text/javascript">

    RED.nodes.registerType('contact-sensor', {
        category: 'zigbee2mqtt_sensor',
        color: '#fcba03',
        defaults: {
            name: { value: "" },
            bridge: { value: "", type: "zigbee2mqtt-bridge-config" },
            deviceName: { value: "", required: true },
        },
        inputs: 0,
        outputs: 2,
        icon: "feed.png",
        label: function () {
            return this.name || "Contact sensor";
        },
        outputLabels: ["closed", "open"],
        oneditprepare: function () {
            var node = this;
            var deviceName = node.deviceName;

            $("#node-input-bridge").change(function () {
                var bridgeId = $("#node-input-bridge").val().replace(".", "_");
                $.getJSON('/z2m/devices/' + bridgeId + '/endDevice/all/all', function (data) {
                    $("#node-input-deviceName").empty();
                    data.devices.forEach(e => {
                        $("#node-input-deviceName").append("<option>" + e.friendly_name + "</option>");
                    });

                    $("#node-input-deviceName").val(deviceName);
                });
            });
        }
    });

</script>

<script type="text/html" data-template-name="contact-sensor">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-bridge"><i class="fa fa-tag"></i> Bridge</label>
        <input type="text" id="node-input-bridge" placeholder="bridge" />
    </div>
    <div class="form-row">
        <label for="node-input-deviceName"><i class="fa fa-tag"></i> Device</label>
        <select id="node-input-deviceName"></select>
    </div>

</script>

<script type="text/html" data-help-name="contact-sensor">
    <p>Sends a new message when a contact sensor state changes.</p>
    <h3>Output</h3>
    <dl class="message-properties">
        <dt> payload <span class="property-type"> object </span> </dt>
        <dd> The MQTT payload of the device </dd>
    </dl>
</script>

<!--- OCCUPANCY SENSOR NODE --->
<script type="text/javascript">

    RED.nodes.registerType('occupancy-sensor', {
        category: 'zigbee2mqtt_sensor',
        color: '#fcba03',
        defaults: {
            name: { value: "" },
            bridge: { value: "", type: "zigbee2mqtt-bridge-config" },
            deviceName: { value: "", required: true },
        },
        inputs: 0,
        outputs: 2,
        icon: "feed.png",
        label: function () {
            return this.name || "Occupancy sensor";
        },
        outputLabels: ["occupied", "no motion"],
        oneditprepare: function () {
            var node = this;
            var deviceName = node.deviceName;

            $("#node-input-bridge").change(function () {
                var bridgeId = $("#node-input-bridge").val().replace(".", "_");
                $.getJSON('/z2m/devices/' + bridgeId + '/endDevice/all/all', function (data) {
                    $("#node-input-deviceName").empty();
                    data.devices.forEach(e => {
                        $("#node-input-deviceName").append("<option>" + e.friendly_name + "</option>");
                    });

                    $("#node-input-deviceName").val(deviceName);
                });
            });
        }
    });

</script>

<script type="text/html" data-template-name="occupancy-sensor">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-bridge"><i class="fa fa-tag"></i> Bridge</label>
        <input type="text" id="node-input-bridge" placeholder="bridge" />
    </div>
    <div class="form-row">
        <label for="node-input-deviceName"><i class="fa fa-tag"></i> Device</label>
        <select id="node-input-deviceName"></select>
    </div>

</script>

<script type="text/html" data-help-name="occupancy-sensor">
    <p>Sends a new message when a occupancy sensor state changes.</p>
    <h3>Output</h3>
    <dl class="message-properties">
        <dt> payload <span class="property-type"> object </span> </dt>
        <dd> The MQTT payload of the device </dd>
    </dl>
</script>

<!--- BUTTON SWITCH NODE --->
<script type="text/javascript">

    RED.nodes.registerType('button-switch', {
        category: 'zigbee2mqtt-utils',
        color: '#97f798',
        defaults: {
            name: { value: "" },
        },
        inputs: 1,
        outputs: 4,
        icon: "function.png",
        label: function () {
            return this.name || "button-switch";
        },
        outputLabels: ["pressed", "hold", "released", "double"],
        oneditprepare: function () {
            RED.bavaria.ui.addNumRangeInput("#node-input-brightness", 0, 255);
        },
    });
</script>

<script type="text/html" data-template-name="button-switch">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>

</script>

<script type="text/html" data-help-name="button-switch">
    <p>Node to switch button press types</p>
</script>

<!--- PREPARE MESSAGES NODE --->
<script type="text/javascript">

    RED.nodes.registerType('send-messages', {
        category: 'zigbee2mqtt',
        color: '#bada66',
        defaults: {
            name: { value: "" },
            bridge: { value: "", type: "zigbee2mqtt-bridge-config" },
        },
        inputs: 1,
        outputs: 0,
        icon: "bridge.svg",
        label: function () {
            return this.name || "send messages";
        },
    });
</script>

<script type="text/html" data-template-name="send-messages">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-bridge"><i class="fa fa-tag"></i> Bridge</label>
        <input type="text" id="node-input-bridge" placeholder="bridge" />
    </div>

</script>

<script type="text/html" data-help-name="send-messages">
    <p>Node to send messages to devices</p>
</script>

<!--- OVERRIDE BRIGHTNESS NODE --->
<script type="text/javascript">
    RED.nodes.registerType('override-brightness', {
        category: 'zigbee2mqtt',
        color: '#bada66',
        defaults: {
            name: { value: "" },
            brightness: { value: 255, validate: RED.bavaria.validators.range(0, 255) },
        },
        inputs: 1,
        outputs: 1,
        icon: "template.png",
        label: function () {
            return this.name || "override-brightness";
        },
        oneditprepare: function () {
            RED.bavaria.ui.addNumRangeInput("#node-input-brightness", 0, 255);
        },
    });
</script>

<script type="text/html" data-template-name="override-brightness">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>

    <div class="form-row">
        <label for="node-input-brightness"><i class="fa fa-sun-o"></i> Brightness</label>
        <input type="text" id="node-input-brightness">
    </div>

</script>

<script type="text/html" data-help-name="override-brightness">
    <p>Node to override brightness</p>
</script>

<!--- OVERRIDE TEMPERATURE NODE --->
<script type="text/javascript">

    RED.nodes.registerType('override-temperature', {
        category: 'zigbee2mqtt',
        color: '#bada66',
        defaults: {
            name: { value: "" },
            temperature: { value: 255, validate: RED.bavaria.validators.range(0, 500) },
        },
        inputs: 1,
        outputs: 1,
        icon: "template.png",
        label: function () {
            return this.name || "override-temperature";
        },
        oneditprepare: function () {
            RED.bavaria.ui.addNumRangeInput("#node-input-temperature", 0, 500);
        },
    });
</script>

<script type="text/html" data-template-name="override-temperature">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>

    <div class="form-row">
        <label for="node-input-temperature"><i class="fa fa-thermometer-full"></i> Temperature</label>
        <input type="text" id="node-input-temperature">
    </div>

</script>

<script type="text/html" data-help-name="override-temperature">
    <p>Node to overrite color temperature</p>
</script>

<!--- OVERRIDE COLOR NODE --->
<script type="text/javascript">

    RED.nodes.registerType('override-color', {
        category: 'zigbee2mqtt',
        color: '#bada66',
        defaults: {
            name: { value: "" },
            red: { value: 255, validate: RED.bavaria.validators.range(0, 255) },
            green: { value: 255, validate: RED.bavaria.validators.range(0, 255) },
            blue: { value: 255, validate: RED.bavaria.validators.range(0, 255) },
        },
        inputs: 1,
        outputs: 1,
        icon: "template.png",
        label: function () {
            return this.name || "override-color";
        },
        oneditprepare: function () {
            var numInputs = ["#node-input-red", "#node-input-green", "#node-input-blue"];
            RED.bavaria.ui.addNumRangeInputs(numInputs, 0, 255);
        },
    });
</script>

<script type="text/html" data-template-name="override-color">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>

    <div class="form-row">
        <label for="node-input-temperature"><i class="fa fa-paint-brush"></i> Red</label>
        <input type="text" id="node-input-red">
    </div>

    <div class="form-row">
        <label for="node-input-temperature"><i class="fa fa-paint-brush"></i> Green</label>
        <input type="text" id="node-input-green">
    </div>

    <div class="form-row">
        <label for="node-input-temperature"><i class="fa fa-paint-brush"></i> Blue</label>
        <input type="text" id="node-input-blue">
    </div>

</script>

<script type="text/html" data-help-name="override-temperature">
    <p>Node to override color</p>
</script>

<script type="text/html" data-help-name="scene-out">
    <p>Node to trigger scenes</p>
</script>

<!--- SCENE IN NODE --->
<script type="text/javascript">
    RED.nodes.registerType('scene-in', {
        category: 'zigbee2mqtt_scene',
        color: '#bada66',
        defaults: {
            name: { value: "" },
            scene: { value: "", required: true },
        },
        inputs: 0,
        outputs: 1,
        icon: "inject.png",
        label: function () {
            return this.name || this.scene || "scene in";
        },
    });
</script>

<script type="text/html" data-template-name="scene-in">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-scene"><i class="fa fa-tag"></i> Scene</label>
        <input type="text" id="node-input-scene">
    </div>

</script>

<script type="text/html" data-help-name="scene-in">
    <p>Node to trigger scenes</p>
</script>

<!--- SCENE SELECTOR NODE --->
<script type="text/javascript">

    function getSelection() {
        return $("#selected-scenes li span").map(function () { return $(this).text() }).get();
    }

    function initSelection(scenes) {
        scenes.forEach(scene => {
            addToSelection(scene);
        });
    }

    function addToSelection(scene) {
        $("#selected-scenes").append('<li style="background: #f5f5f5;padding: 10px;list-style-type: none;right: 0px;border: 1px solid;border-radius: 5px;border-color: rgb(204, 204, 204);"><span>' + scene + '</span><button onclick="removeScene(this)" style="position:absolute;right: 8px;margin-top: -3px;border-radius: 5px;border: 1px solid;border-color: rgb(204, 204, 204);">x</button></li>');
    }

    function removeScene(a) {
        $(a).parent().remove();
        refreshScenes();
    }

    function refreshScenes() {
        $.getJSON('/z2m/scenes', function (data) {
            var selection = getSelection();

            var scenes = data.scenes.filter(f => {
                return (selection.length === 0 || selection.every(s => s != f)) && selection.length < data.scenes.length;
            });

            $("#available-scenes").empty();

            scenes.forEach(scene => {
                $("#available-scenes").append("<option>" + scene + "</option>");
            });
        });
    }

    RED.nodes.registerType('scene-selector', {
        category: 'zigbee2mqtt_scene',
        color: '#bada66',
        defaults: {
            name: { value: "" },
            scenes: { value: [], required: true },
        },
        inputs: 1,
        outputs: 0,
        icon: "debug.png",
        label: function () {
            return this.name || this.scene || "scene selector";
        },
        oneditprepare: function () {
            initSelection(this.scenes);

            $("#scene-add-button").click(function () {
                var scene = $("#available-scenes").val();
                if (!scene) {
                    return;
                }

                var scenes = getSelection();
                if (scenes.some(s => s == scene)) {
                    return;
                }

                addToSelection(scene);
                refreshScenes();
            });

            refreshScenes();
        },
        oneditsave: function () {
            console.log(this.scenes);
            this.scenes = getSelection();
        }
    });
</script>

<script type="text/html" data-template-name="scene-selector">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-scene"><i class="fa fa-tag"></i> Scenes</label>
        <div id="input-scenes" style="display:inline;">
            <select id="available-scenes">
            </select>
            <button type="button" class="red-ui-button" id="scene-add-button">add scene</button>
            <div>
                <ul id="selected-scenes" style="margin: 10px 0px 0px 105px;width: 70%;position: relative;right: 0px;"></ul>
            </div>
        </div>
    </div>

</script>

<script type="text/html" data-help-name="scene-selector">
    <p>Node to trigger scenes</p>
</script>

<!--- CLIMATE SENSOR NODE --->
<script type="text/javascript">
    RED.nodes.registerType('climate-sensor', {
        category: 'zigbee2mqtt_sensor',
        color: '#bada66',
        defaults: {
            name: { value: "" },
            deviceName: { value: "", required: true },
            bridge: { value: "", type: "zigbee2mqtt-bridge-config" },
            temperature: { value: true },
            pressure: { value: true },
            humidity: { value: true }
        },
        inputs: 0,
        outputs: 1,
        icon: "serial.png",
        label: function () {
            return this.name || "climate sensor";
        },
        oneditprepare: function () {
            var node = this;
            var deviceName = node.deviceName;

            $("#node-input-bridge").change(function () {
                var bridgeId = $("#node-input-bridge").val().replace(".", "_");
                $.getJSON('/z2m/devices/' + bridgeId + '/endDevice/all/all', function (data) {
                    $("#node-input-deviceName").empty();
                    data.devices.forEach(e => {
                        $("#node-input-deviceName").append("<option>" + e.friendly_name + "</option>");
                    });

                    $("#node-input-deviceName").val(deviceName);
                });
            });
        }
    });
</script>

<script type="text/html" data-template-name="climate-sensor">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-bridge"><i class="fa fa-tag"></i> Bridge</label>
        <input type="text" id="node-input-bridge" placeholder="bridge" />
    </div>
    <div class="form-row">
        <label for="node-input-deviceName"><i class="fa fa-tag"></i> Device</label>
        <select id="node-input-deviceName"></select>
    </div>
    <div class="form-row">
        <label for="node-input-temperature"><i class="fa fa-tag"></i>Temperature</label>
        <input type="checkbox" id="node-input-temperature" />
    </div>
    <div class="form-row">
        <label for="node-input-pressure"><i class="fa fa-tag"></i>Pressure</label>
        <input type="checkbox" id="node-input-pressure" />
    </div>
    <div class="form-row">
        <label for="node-input-humidity"><i class="fa fa-tag"></i>Humidity</label>
        <input type="checkbox" id="node-input-humidity" />
    </div>

</script>

<script type="text/html" data-help-name="climate-sensor">
    <p>Node to trigger scenes</p>
</script>

<!--- CLIMATE SENSOR NODE --->
<script type="text/javascript">
    RED.nodes.registerType('device-status', {
        category: 'zigbee2mqtt',
        color: '#bada66',
        defaults: {
            name: { value: "" },
            deviceName: { value: "", required: true },
            bridge: { value: "", type: "zigbee2mqtt-bridge-config" },
            genericMqttDevice: { value: false },
            device: { value: "", type: "zigbee2mqtt-device-config", required: false}
        },
        inputs: 0,
        outputs: 1,
        icon: "serial.png",
        label: function () {
            return this.name || "device status";
        },
        oneditprepare: function () {
            var node = this;
            var deviceName = node.deviceName;
            
            if (node.genericMqttDevice === true) {
                $("#fullMqttTopic").show()
            } else {
                $("#fullMqttTopic").hide()
            }

            $("#node-input-genericMqttDevice").change(function () {
                if (this.checked) {
                    $("#fullMqttTopic").show()
                    node.deviceName = "---";
                } else {
                    $("#fullMqttTopic").hide()
                    node.deviceName = "";
                }
            })

            $("#node-input-bridge").change(function () {
                var bridgeId = $("#node-input-bridge").val().replace(".", "_");
                $.getJSON('/z2m/devices/' + bridgeId + '/all/all/all', function (data) {
                    $("#node-input-deviceName").empty();
                    data.devices.forEach(e => {
                        $("#node-input-deviceName").append("<option>" + e.friendly_name + "</option>");
                    });

                    $("#node-input-deviceName").val(deviceName);
                });
            });
        }
    });
</script>

<script type="text/html" data-template-name="device-status">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-bridge"><i class="fa fa-tag"></i> Bridge</label>
        <input type="text" id="node-input-bridge" placeholder="bridge" />
    </div>
    <div class="form-row">
        <label for="node-input-deviceName"><i class="fa fa-tag"></i> Device</label>
        <select id="node-input-deviceName"></select>
    </div>
    <div class="form-row">
        <label for="node-input-genericMqttDevice"><i class="fa fa-tag"></i> Generic MQTT Device</label>
        <input type="checkbox" id="node-input-genericMqttDevice" />
    </div>
    <div class="form-row" id="fullMqttTopic">
        <label for="node-input-device"><i class="fa fa-tag"></i> Device</label>
        <input type="text" id="node-input-device" placeholder="device" />
    </div>

</script>

<script type="text/html" data-help-name="device-status">
    <p>Injects a message with the every mqtt payload a device publishes</p>
</script>

<!--- GET LAMP STATE NODE --->
<script type="text/javascript">
    RED.nodes.registerType('get-lamp-state', {
        category: 'zigbee2mqtt',
        color: '#bada66',
        defaults: {
            name: { value: "" },
            device: {
                value: "",
                type: "zigbee2mqtt-device-config",
                validate: function (value) {
                    prepareView();
                    return true;
                }
            },
            bridge: { value: "", type: "zigbee2mqtt-bridge-config" },
        },
        inputs: 1,
        outputs: 1,
        icon: "serial.png",
        label: function () {
            return this.name || "get lamp state";
        },
    });
</script>

<script type="text/html" data-template-name="get-lamp-state">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-bridge"><i class="fa fa-tag"></i> Bridge</label>
        <input type="text" id="node-input-bridge" placeholder="bridge" />
    </div>
    <div class="form-row">
        <label for="node-input-device"><i class="fa fa-tag"></i> Device</label>
        <input type="text" id="node-input-device" />
    </div>

</script>

<script type="text/html" data-help-name="get-lamp-state">
    <p>Requests the current lamp state and adds the payload to the message</p>
</script>