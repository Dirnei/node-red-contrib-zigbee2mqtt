<script type="text/javascript">
    function refresh() {
        RED.nodes.eachNode(function (node) {

        });
    }

    RED.sidebar.addTab({
        id: "zigbee2mqtt",
        label: "Zigbee 2 MQTT",
        name: "zigbee2mqtt",
        content: "<div class=\"nr-db-sb\">TODO: Add overview of all devices</div>",
        closeable: true,
        pinned: true,
        iconClass: "fa fa-cloud",
        disableOnEdit: true,
        onchange: function () { refresh(); }
    });

    if (RED.bavaria === undefined) {
        RED.bavaria = {
            validators: {
                range: function (min, max) {
                    return function (v) {
                        return v <= max && v >= min;
                    }
                }
            },
            ui: {
                addNumInput: function (element) {
                    $(element).typedInput({
                        type: "num",
                        types: ["num"],
                    });
                },
                addNumInputs: function (elements) {
                    elements.forEach(RED.bavaria.ui.addNumInput);
                },
                addNumRangeInput: function (element, min, max) {
                    RED.bavaria.ui.addNumInput(element);
                    var validator = RED.bavaria.validators.range(min, max);

                    $(element).change(function () {
                        var valid = validator($(this).val());
                        var targetElement = $(this).parent().find('.red-ui-typedInput-container');
                        if (!valid) {
                            targetElement.addClass('input-error');
                        } else {
                            targetElement.removeClass('input-error');
                        }
                    });
                },
                addNumRangeInputs: function (elements, min, max) {
                    elements.forEach(element => {
                        RED.bavaria.ui.addNumRangeInput(element, min, max);
                    });
                }
            }
        }
    }
</script>

<!--- GENERIC LAMP NODE --->
<script type="text/javascript">
    function showInput(name) {
        $("#node-input-" + name).parent().show();
    }

    function hideInput(name) {
        $("#node-input-" + name).parent().hide();
    }

    function prepareView() {
        var config = RED.nodes.node($("#node-input-device").val());

        if (config === undefined || config === null) {
            return;
        }

        if (config.brightnessSupport) {
            showInput("transition");
            showInput("brightness");
        }
        else {
            hideInput("brightness");
            hideInput("transition");
        }

        if (config.temperatureSupport) {
            showInput("temperature");
        }
        else {
            hideInput("temperature");
        }

        if (config.colorSupport) {
            showInput("red");
            showInput("green");
            showInput("blue");
        }
        else {
            hideInput("red");
            hideInput("green");
            hideInput("blue");
        }

        return true;
    }

    RED.nodes.registerType('generic-lamp', {
        category: 'zigbee2mqtt',
        color: '#bada66',
        defaults: {
            device: {
                value: "",
                type: "zigbee2mqtt-device-config",
                validate: function (value) {
                    prepareView();
                    return true;
                }
            },

            bridge: { value: "", type: "zigbee2mqtt-bridge-config" },

            name: { value: "" },
            state: { value: "ON" },

            brightness: { value: 0, validate: RED.bavaria.validators.range(0, 255) },

            temperature: { value: 50, validate: RED.bavaria.validators.range(0, 500000) },

            red: { value: 0, validate: RED.bavaria.validators.range(0, 255) },
            green: { value: 0, validate: RED.bavaria.validators.range(0, 255) },
            blue: { value: 0, validate: RED.bavaria.validators.range(0, 255) },

            transition: { value: 2 },
            delay: { value: 0 },
        },
        inputs: 1,
        outputs: 1,
        icon: "light.png",
        label: function () {
            return this.name || "generic device";
        },
        oneditprepare: function () {
            var numInputs = [
                "#node-input-brightness",
                "#node-input-red",
                "#node-input-green",
                "#node-input-blue",
            ]

            RED.bavaria.ui.addNumRangeInput("#node-input-temperature", 0, 500000);

            RED.bavaria.ui.addNumRangeInputs(numInputs, 0, 255);

            RED.bavaria.ui.addNumInput("#node-input-delay");
            RED.bavaria.ui.addNumInput("#node-input-transition");

            prepareView();
        },
        oneditsave: function () {
            var config = RED.nodes.node($("#node-input-device").val());
            $("#node-input-name").val(config.name);
        },
    });
</script>

<script type="text/html" data-template-name="generic-lamp">

    <div class="form-row">
        <label for="node-input-device"><i class="fa fa-tag"></i> Device</label>
        <input type="text" id="node-input-device" />
    </div>
    <div class="form-row">
        <label for="node-input-bridge"><i class="fa fa-tag"></i> Bridge</label>
        <input type="text" id="node-input-bridge"  />
    </div>
    <div class="form-row" style="display:none">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="hidden" id="node-input-name">
    </div>

    <div class="form-row">
        <label for="node-input-state"><i class="fa fa-power-off"></i> State</label>
        <select id="node-input-state">
            <option value="ON">On</option>
            <option value="OFF">Off</option>
            <option value="TOGGLE">Toggle</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-brightness"><i class="fa fa-sun-o"></i> Brightness</label>
        <input type="text" id="node-input-brightness">
    </div>
    <div class="form-row">
        <label for="node-input-temperature"><i class="fa fa-thermometer-full"></i> Temperature</label>
        <input type="text" id="node-input-temperature">
    </div>
    <div class="form-row">
        <label for="node-input-red"><i class="fa fa-paint-brush"></i> Red</label>
        <input type="text" id="node-input-red">
    </div>
    <div class="form-row">
        <label for="node-input-green"><i class="fa fa-paint-brush"></i> Green</label>
        <input type="text" id="node-input-green">
    </div>
    <div class="form-row">
        <label for="node-input-blue"><i class="fa fa-paint-brush"></i> Blue</label>
        <input type="text" id="node-input-blue">
    </div>
    <div class="form-row">
        <label for="node-input-transition"><i class="fa fa-clock-o"></i> Transition</label>
        <input type="text" id="node-input-transition">
    </div>
    <div class="form-row">
        <label for="node-input-delay"><i class="fa fa-clock-o"></i> Delay</label>
        <input type="text" id="node-input-delay" >
    </div>
</script>

<script type="text/html" data-help-name="generic-lamp">
    <p>Node for generic lamp devices</p>
</script>

<!--- CONTACT SENSOR NODE --->
<script type="text/javascript">

    RED.nodes.registerType('contact-sensor', {
        category: 'zigbee2mqtt_sensor',
        color: '#fcba03',
        defaults: {
            name: { value: "" },
            bridge: { value: "", type: "zigbee2mqtt-bridge-config" },
            deviceName: { value: "", required: true },
        },
        inputs: 0,
        outputs: 2,
        icon: "feed.png",
        label: function () {
            return this.name || "Contact sensor";
        },
        outputLabels: ["closed", "open"],
        oneditprepare: function () {
            var node = this;
            var deviceName = node.deviceName;

            $("#node-input-bridge").change(function () {
                var bridgeId = $("#node-input-bridge").val().replace(".", "_");
                $.getJSON('/z2m/devices/' + bridgeId + '/endDevice/all/all', function (data) {
                    $("#node-input-deviceName").empty();
                    data.devices.forEach(e => {
                        $("#node-input-deviceName").append("<option>" + e.friendly_name + "</option>");
                    });

                    $("#node-input-deviceName").val(deviceName);
                });
            });
        }
    });

</script>

<script type="text/html" data-template-name="contact-sensor">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-bridge"><i class="fa fa-tag"></i> Bridge</label>
        <input type="text" id="node-input-bridge" placeholder="bridge" />
    </div>
    <div class="form-row">
        <label for="node-input-deviceName"><i class="fa fa-tag"></i> Device</label>
        <select id="node-input-deviceName"></select>
    </div>

</script>

<script type="text/html" data-help-name="contact-sensor">
    <p>Sends a new message when a contact sensor state changes.</p>
    <h3>Output</h3>
    <dl class="message-properties">
        <dt> payload <span class="property-type"> object </span> </dt>
        <dd> The MQTT payload of the device </dd>
    </dl>
</script>

<!--- OCCUPANCY SENSOR NODE --->
<script type="text/javascript">

    RED.nodes.registerType('occupancy-sensor', {
        category: 'zigbee2mqtt_sensor',
        color: '#fcba03',
        defaults: {
            name: { value: "" },
            bridge: { value: "", type: "zigbee2mqtt-bridge-config" },
            deviceName: { value: "", required: true },
        },
        inputs: 0,
        outputs: 2,
        icon: "feed.png",
        label: function () {
            return this.name || "Occupancy sensor";
        },
        outputLabels: ["occupied", "no motion"],
        oneditprepare: function () {
            var node = this;
            var deviceName = node.deviceName;

            $("#node-input-bridge").change(function () {
                var bridgeId = $("#node-input-bridge").val().replace(".", "_");
                $.getJSON('/z2m/devices/' + bridgeId + '/endDevice/all/all', function (data) {
                    $("#node-input-deviceName").empty();
                    data.devices.forEach(e => {
                        $("#node-input-deviceName").append("<option>" + e.friendly_name + "</option>");
                    });

                    $("#node-input-deviceName").val(deviceName);
                });
            });
        }
    });

</script>

<script type="text/html" data-template-name="occupancy-sensor">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-bridge"><i class="fa fa-tag"></i> Bridge</label>
        <input type="text" id="node-input-bridge" placeholder="bridge" />
    </div>
    <div class="form-row">
        <label for="node-input-deviceName"><i class="fa fa-tag"></i> Device</label>
        <select id="node-input-deviceName"></select>
    </div>

</script>

<script type="text/html" data-help-name="occupancy-sensor">
    <p>Sends a new message when an occupancy sensor state changes.</p>
    <h3>Output</h3>
    <dl class="message-properties">
        <dt> payload <span class="property-type"> object </span> </dt>
        <dd> The MQTT payload of the device </dd>
    </dl>
</script>

<!--- BUTTON SWITCH NODE --->
<script type="text/javascript">

    RED.nodes.registerType('button-switch', {
        category: 'zigbee2mqtt-utils',
        color: '#97f798',
        defaults: {
            name: { value: "" },
        },
        inputs: 1,
        outputs: 4,
        icon: "function.png",
        label: function () {
            return this.name || "button-switch";
        },
        outputLabels: ["pressed", "hold", "released", "double"],
        oneditprepare: function () {
            RED.bavaria.ui.addNumRangeInput("#node-input-brightness", 0, 255);
        },
    });
</script>

<script type="text/html" data-template-name="button-switch">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>

</script>

<script type="text/html" data-help-name="button-switch">
    <p>Node to switch button press types</p>
</script>

<!--- PREPARE MESSAGES NODE --->
<script type="text/javascript">

    RED.nodes.registerType('send-messages', {
        category: 'zigbee2mqtt',
        color: '#bada66',
        defaults: {
            name: { value: "" },
            bridge: { value: "", type: "zigbee2mqtt-bridge-config" },
        },
        inputs: 1,
        outputs: 0,
        icon: "bridge.svg",
        label: function () {
            return this.name || "send messages";
        },
    });
</script>

<script type="text/html" data-template-name="send-messages">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-bridge"><i class="fa fa-tag"></i> Bridge</label>
        <input type="text" id="node-input-bridge" placeholder="bridge" />
    </div>

</script>

<script type="text/html" data-help-name="send-messages">
    <p>Node to send messages to devices</p>
</script>

<!--- OVERRIDE BRIGHTNESS NODE --->
<script type="text/javascript">
    RED.nodes.registerType('override-brightness', {
        category: 'zigbee2mqtt',
        color: '#bada66',
        defaults: {
            name: { value: "" },
            brightness: { value: 255, validate: RED.bavaria.validators.range(0, 255) },
        },
        inputs: 1,
        outputs: 1,
        icon: "template.png",
        label: function () {
            return this.name || "override-brightness";
        },
        oneditprepare: function () {
            RED.bavaria.ui.addNumRangeInput("#node-input-brightness", 0, 255);
        },
    });
</script>

<script type="text/html" data-template-name="override-brightness">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>

    <div class="form-row">
        <label for="node-input-brightness"><i class="fa fa-sun-o"></i> Brightness</label>
        <input type="text" id="node-input-brightness">
    </div>

</script>

<script type="text/html" data-help-name="override-brightness">
    <p>Node to override brightness</p>
</script>

<!--- OVERRIDE TEMPERATURE NODE --->
<script type="text/javascript">

    RED.nodes.registerType('override-temperature', {
        category: 'zigbee2mqtt',
        color: '#bada66',
        defaults: {
            name: { value: "" },
            temperature: { value: 255, validate: RED.bavaria.validators.range(0, 500) },
        },
        inputs: 1,
        outputs: 1,
        icon: "template.png",
        label: function () {
            return this.name || "override-temperature";
        },
        oneditprepare: function () {
            RED.bavaria.ui.addNumRangeInput("#node-input-temperature", 0, 500);
        },
    });
</script>

<script type="text/html" data-template-name="override-temperature">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>

    <div class="form-row">
        <label for="node-input-temperature"><i class="fa fa-thermometer-full"></i> Temperature</label>
        <input type="text" id="node-input-temperature">
    </div>

</script>

<script type="text/html" data-help-name="override-temperature">
    <p>Node to override color temperature</p>
</script>

<!--- OVERRIDE COLOR NODE --->
<script type="text/javascript">

    RED.nodes.registerType('override-color', {
        category: 'zigbee2mqtt',
        color: '#bada66',
        defaults: {
            name: { value: "" },
            red: { value: 255, validate: RED.bavaria.validators.range(0, 255) },
            green: { value: 255, validate: RED.bavaria.validators.range(0, 255) },
            blue: { value: 255, validate: RED.bavaria.validators.range(0, 255) },
        },
        inputs: 1,
        outputs: 1,
        icon: "template.png",
        label: function () {
            return this.name || "override-color";
        },
        oneditprepare: function () {
            var numInputs = ["#node-input-red", "#node-input-green", "#node-input-blue"];
            RED.bavaria.ui.addNumRangeInputs(numInputs, 0, 255);
        },
    });
</script>

<script type="text/html" data-template-name="override-color">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>

    <div class="form-row">
        <label for="node-input-temperature"><i class="fa fa-paint-brush"></i> Red</label>
        <input type="text" id="node-input-red">
    </div>

    <div class="form-row">
        <label for="node-input-temperature"><i class="fa fa-paint-brush"></i> Green</label>
        <input type="text" id="node-input-green">
    </div>

    <div class="form-row">
        <label for="node-input-temperature"><i class="fa fa-paint-brush"></i> Blue</label>
        <input type="text" id="node-input-blue">
    </div>

</script>

<script type="text/html" data-help-name="override-temperature">
    <p>Node to override color</p>
</script>

<script type="text/html" data-help-name="scene-out">
    <p>Node to trigger scenes</p>
</script>

<!--- CLIMATE SENSOR NODE --->
<script type="text/javascript">
    RED.nodes.registerType('climate-sensor', {
        category: 'zigbee2mqtt_sensor',
        color: '#bada66',
        defaults: {
            name: { value: "" },
            deviceName: { value: "", required: true },
            bridge: { value: "", type: "zigbee2mqtt-bridge-config" },
            temperature: { value: true },
            pressure: { value: true },
            humidity: { value: true }
        },
        inputs: 0,
        outputs: 1,
        icon: "serial.png",
        label: function () {
            return this.name || "climate sensor";
        },
        oneditprepare: function () {
            var node = this;
            var deviceName = node.deviceName;

            $("#node-input-bridge").change(function () {
                var bridgeId = $("#node-input-bridge").val().replace(".", "_");
                $.getJSON('/z2m/devices/' + bridgeId + '/endDevice/all/all', function (data) {
                    $("#node-input-deviceName").empty();
                    data.devices.forEach(e => {
                        $("#node-input-deviceName").append("<option>" + e.friendly_name + "</option>");
                    });

                    $("#node-input-deviceName").val(deviceName);
                });
            });
        }
    });
</script>

<script type="text/html" data-template-name="climate-sensor">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-bridge"><i class="fa fa-tag"></i> Bridge</label>
        <input type="text" id="node-input-bridge" placeholder="bridge" />
    </div>
    <div class="form-row">
        <label for="node-input-deviceName"><i class="fa fa-tag"></i> Device</label>
        <select id="node-input-deviceName"></select>
    </div>
    <div class="form-row">
        <label for="node-input-temperature"><i class="fa fa-tag"></i>Temperature</label>
        <input type="checkbox" id="node-input-temperature" />
    </div>
    <div class="form-row">
        <label for="node-input-pressure"><i class="fa fa-tag"></i>Pressure</label>
        <input type="checkbox" id="node-input-pressure" />
    </div>
    <div class="form-row">
        <label for="node-input-humidity"><i class="fa fa-tag"></i>Humidity</label>
        <input type="checkbox" id="node-input-humidity" />
    </div>

</script>

<script type="text/html" data-help-name="climate-sensor">
    <p>Node to trigger scenes</p>
</script>

<!--- CLIMATE SENSOR NODE --->
<script type="text/javascript">
    RED.nodes.registerType('device-status', {
        category: 'zigbee2mqtt',
        color: '#bada66',
        defaults: {
            name: { value: "" },
            deviceName: { value: "", required: true },
            bridge: { value: "", type: "zigbee2mqtt-bridge-config" },
            genericMqttDevice: { value: false },
            device: { value: "", type: "zigbee2mqtt-device-config", required: false}
        },
        inputs: 0,
        outputs: 1,
        icon: "serial.png",
        label: function () {
            return this.name || "device status";
        },
        oneditprepare: function () {
            var node = this;
            var deviceName = node.deviceName;
            
            if (node.genericMqttDevice === true) {
                $("#fullMqttTopic").show()
            } else {
                $("#fullMqttTopic").hide()
            }

            $("#node-input-genericMqttDevice").change(function () {
                if (this.checked) {
                    $("#fullMqttTopic").show()
                    node.deviceName = "---";
                } else {
                    $("#fullMqttTopic").hide()
                    node.deviceName = "";
                }
            })

            $("#node-input-bridge").change(function () {
                var bridgeId = $("#node-input-bridge").val().replace(".", "_");
                $.getJSON('/z2m/devices/' + bridgeId + '/all/all/all', function (data) {
                    $("#node-input-deviceName").empty();
                    data.devices.forEach(e => {
                        $("#node-input-deviceName").append("<option>" + e.friendly_name + "</option>");
                    });

                    $("#node-input-deviceName").val(deviceName);
                });
            });
        }
    });
</script>

<script type="text/html" data-template-name="device-status">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-bridge"><i class="fa fa-tag"></i> Bridge</label>
        <input type="text" id="node-input-bridge" placeholder="bridge" />
    </div>
    <div class="form-row">
        <label for="node-input-deviceName"><i class="fa fa-tag"></i> Device</label>
        <select id="node-input-deviceName"></select>
    </div>
    <div class="form-row">
        <label for="node-input-genericMqttDevice"><i class="fa fa-tag"></i> Generic MQTT Device</label>
        <input type="checkbox" id="node-input-genericMqttDevice" />
    </div>
    <div class="form-row" id="fullMqttTopic">
        <label for="node-input-device"><i class="fa fa-tag"></i> Device</label>
        <input type="text" id="node-input-device" placeholder="device" />
    </div>

</script>

<script type="text/html" data-help-name="device-status">
    <p>Injects a message with every MQTT payload a device publishes</p>
</script>

<!--- GET LAMP STATE NODE --->
<script type="text/javascript">
    RED.nodes.registerType('get-lamp-state', {
        category: 'zigbee2mqtt',
        color: '#bada66',
        defaults: {
            name: { value: "" },
            device: {
                value: "",
                type: "zigbee2mqtt-device-config",
                validate: function (value) {
                    prepareView();
                    return true;
                }
            },
            bridge: { value: "", type: "zigbee2mqtt-bridge-config" },
        },
        inputs: 1,
        outputs: 1,
        icon: "serial.png",
        label: function () {
            return this.name || "get lamp state";
        },
    });
</script>

<script type="text/html" data-template-name="get-lamp-state">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-bridge"><i class="fa fa-tag"></i> Bridge</label>
        <input type="text" id="node-input-bridge" placeholder="bridge" />
    </div>
    <div class="form-row">
        <label for="node-input-device"><i class="fa fa-tag"></i> Device</label>
        <input type="text" id="node-input-device" />
    </div>

</script>

<script type="text/html" data-help-name="get-lamp-state">
    <p>Requests the current lamp state and adds the payload to the message</p>
</script>